# .github/workflows/passive-income.yml
# Sistema de ingresos pasivos 100% automÃ¡tico
# Se ejecuta cada 6 horas y crea productos automÃ¡ticamente

name: ðŸ¤– Passive Income Bot
on:
  # Se ejecuta cada 6 horas automÃ¡ticamente
  schedule:
    - cron: '0 */6 * * *'  # A las 00:00, 06:00, 12:00, 18:00 UTC
  
  # TambiÃ©n permite ejecutar manualmente
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Modo prueba (true/false)'
        required: false
        default: 'false'

jobs:
  content-arbitrage:
    name: ðŸ“Š Crear Productos AutomÃ¡ticos
    runs-on: ubuntu-latest
    timeout-minutes: 15  # LÃ­mite de seguridad
    
    steps:
      # 1. Descargar el cÃ³digo del repositorio
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 2. Configurar Python
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. Instalar dependencias
      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 openai==0.28.1 reportlab python-dotenv
          pip install --no-deps PyPDF2

      # 4. Verificar APIs disponibles
      - name: ðŸ” Check API Keys
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GUMROAD_ACCESS_TOKEN: ${{ secrets.GUMROAD_ACCESS_TOKEN }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "âŒ OPENAI_API_KEY no configurado"
            exit 1
          fi
          if [ -z "$GUMROAD_ACCESS_TOKEN" ]; then
            echo "âŒ GUMROAD_ACCESS_TOKEN no configurado" 
            exit 1
          fi
          echo "âœ… APIs configuradas correctamente"

      # 5. Ejecutar el bot principal
      - name: ðŸš€ Run Content Arbitrage Bot
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GUMROAD_ACCESS_TOKEN: ${{ secrets.GUMROAD_ACCESS_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEST_MODE: ${{ github.event.inputs.test_mode }}
        run: |
          echo "ðŸ¤– Iniciando bot de ingresos pasivos..."
          python main.py
          echo "âœ… Bot ejecutado correctamente"

      # 6. Guardar logs y resultados
      - name: ðŸ’¾ Save Results
        run: |
          # Crear directorio de logs si no existe
          mkdir -p logs
          
          # Guardar log de esta ejecuciÃ³n
          echo "$(date): Bot ejecutado correctamente" >> logs/execution.log
          
          # Mostrar Ãºltimas 10 ejecuciones
          echo "ðŸ“Š Ãšltimas ejecuciones:"
          tail -10 logs/execution.log || echo "Primer ejecuciÃ³n"

      # 7. Commit automÃ¡tico de resultados (opcional)
      - name: ðŸ“ Commit Results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Passive Income Bot"
          git add -A
          
          # Solo commit si hay cambios
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ðŸ¤– Auto: Bot execution $(date '+%Y-%m-%d %H:%M')"
            git push
            echo "âœ… Resultados guardados en GitHub"
          else
            echo "ðŸ“ Sin cambios para guardar"
          fi

      # 8. NotificaciÃ³n de Ã©xito (opcional)
      - name: ðŸŽ‰ Success Notification
        if: success()
        run: |
          echo "ðŸŽ‰ Â¡Bot ejecutado exitosamente!"
          echo "ðŸ“… Fecha: $(date)"
          echo "ðŸ”„ PrÃ³xima ejecuciÃ³n: en 6 horas"
          echo "ðŸ“Š Revisa Gumroad para nuevos productos"

      # 9. Manejo de errores
      - name: âŒ Error Notification
        if: failure()
        run: |
          echo "âŒ Error en la ejecuciÃ³n del bot"
          echo "ðŸ“… Fecha: $(date)"
          echo "ðŸ” Revisa los logs para mÃ¡s detalles"
          echo "ðŸ”„ PrÃ³ximo intento: en 6 horas"

  # Job adicional para estadÃ­sticas (opcional)
  stats:
    name: ðŸ“ˆ Actualizar EstadÃ­sticas
    runs-on: ubuntu-latest
    needs: content-arbitrage
    if: success()
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ“Š Generate Stats
        run: |
          # Crear archivo de estadÃ­sticas
          echo "# ðŸ“Š EstadÃ­sticas del Bot" > STATS.md
          echo "" >> STATS.md
          echo "- **Ãšltima ejecuciÃ³n:** $(date)" >> STATS.md
          echo "- **Estado:** âœ… Funcionando" >> STATS.md
          echo "- **PrÃ³xima ejecuciÃ³n:** $(date -d '+6 hours')" >> STATS.md
          echo "" >> STATS.md
          
          # Contar ejecuciones
          if [ -f logs/execution.log ]; then
            EXEC_COUNT=$(wc -l < logs/execution.log)
            echo "- **Total ejecuciones:** $EXEC_COUNT" >> STATS.md
          fi
          
          echo "" >> STATS.md
          echo "---" >> STATS.md
          echo "*Actualizado automÃ¡ticamente por GitHub Actions*" >> STATS.md

      - name: ðŸ’¾ Save Stats
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Stats Bot"
          git add STATS.md
          
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ðŸ“Š Update stats: $(date '+%Y-%m-%d %H:%M')"
            git push
          fi
